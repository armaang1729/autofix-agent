# When an issue is opened (or labeled 'autofix'), the agent analyzes it,
# proposes a fix, and opens a PR. Requires OPENAI_API_KEY (or compatible) secret.
name: Autofix on issue

on:
  issues:
    types: [opened, labeled]

jobs:
  autofix:
    if: github.event.action == 'opened' || (github.event.action == 'labeled' && contains(github.event.label.name, 'autofix'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run autofix agent
        id: agent
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_VERSION: ${{ secrets.OPENAI_API_VERSION }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          RUNNER_TEMP: ${{ runner.temp }}
        run: node agent/index.mjs

      - name: Read agent output
        id: out
        run: |
          OUT="${{ runner.temp }}/autofix-output.json"
          if [ ! -f "$OUT" ]; then echo "No output from agent"; exit 1; fi
          BRANCH=$(jq -r .branch "$OUT")
          MSG=$(jq -r .commitMessage "$OUT")
          SKIP=$(jq -r .skip "$OUT")
          REASON=$(jq -r .reason "$OUT")
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          echo "$MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "skip=$SKIP" >> $GITHUB_OUTPUT
          echo "reason<<EOF" >> $GITHUB_OUTPUT
          echo "$REASON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on issue when skipped
        if: steps.out.outputs.skip == 'true'
        uses: actions/github-script@v7
        with:
          reason: ${{ steps.out.outputs.reason }}
          script: |
            const reason = core.getInput('reason') || 'No reason provided.';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸ¤– **Autofix agent** could not produce a fix automatically.\n\n' + reason + '\n\nPlease add more context to the issue or fix manually.'
            });

      - name: Create branch, commit, push and open PR
        id: push
        if: steps.out.outputs.skip != 'true' && steps.out.outputs.branch != ''
        env:
          BRANCH: ${{ steps.out.outputs.branch }}
          COMMIT_MSG: ${{ steps.out.outputs.commit_message }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add -A
          if git diff --staged --quiet; then
            echo "No diff after agent run; skipping PR"
            echo "pushed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "pushed=true" >> $GITHUB_OUTPUT
          git commit -m "$COMMIT_MSG"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git "$BRANCH"

      - name: Open Pull Request
        if: steps.push.outputs.pushed == 'true'
        uses: actions/github-script@v7
        with:
          branch: ${{ steps.out.outputs.branch }}
          commit_message: ${{ steps.out.outputs.commit_message }}
          script: |
            const branch = core.getInput('branch');
            const commitMessage = core.getInput('commit_message');
            const issue = context.issue.number;
            const title = (commitMessage || '').split('\n')[0].trim() || `Fix #${issue}`;
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              head: branch,
              base: 'main',
              body: `## Autofix PR\n\nThis PR was created by the autofix agent for issue #${issue}.\n\nFixes #${issue}`,
            });
